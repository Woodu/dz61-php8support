# Week 17 任务规划 - P0/P1核心功能完善

**日期**: 2026-02-21
**状态**: ⏳ 待开始
**预计周期**: 7天
**主要目标**: 测试覆盖率提升到98%+ + P0/P1核心功能补全

---

## 📊 当前状态回顾

### Week 16 成果
- ✅ 8个任务处理完毕（7个完成 + 1个延期）
- ✅ 测试完成率: 83% → 94% (+11%)
- ✅ 安全功能完整 (CSRF + FloodControl + GD CAPTCHA)
- ✅ P0阻塞问题全部解决
- ✅ Session兼容性修复
- ✅ 邮件功能移除 (无sendmail错误)

### Week 17 前置状态
**项目进度**: 77%
- P0 Critical Path: 98% (仅剩2%测试覆盖率)
- P1 Core Features: 53% (前端交互表单缺失)

**测试完成率**: 94% (2501/2637)
- 剩余失败: 136个测试
- 目标: 98%+ (2584/2637)

**生产就绪度**: 77%
- 核心浏览功能: 100% ✅
- 安全功能: 100% ✅
- 交互表单: 0% ❌
- 测试覆盖率: 94% ⚠️

---

## 🎯 Week 17 核心目标

### 目标 1: 测试覆盖率提升到98%+ (P0)
**优先级**: 🔴 P0 - Critical
**预计耗时**: 16小时 (2天)

**原因**:
- Week 16已解决所有P0阻塞问题
- 当前94%覆盖率很高，但剩余136个失败测试需修复
- 达到98%+才能确保生产稳定性

**成功标准**:
- 测试完成率 ≥ 98% (2584/2637)
- 无P0/P1级别错误
- 剩余失败测试仅为P2/P3级别

### 目标 2: P0/P1核心功能补全 (P1)
**优先级**: 🟡 P1 - High
**预计耗时**: 24小时 (3天)

**范围**:
- Week 6: Payment/Poll/Post Controllers (遗留任务)
- Week 7: Attachment System优化
- Week 8: Advanced Threads (部分功能)

**成功标准**:
- PaymentController完整集成
- PollController前端集成
- PostController优化完成
- Attachment上传UI完整

### 目标 3: 文档更新 (P1)
**优先级**: 🟡 P1 - High
**预计耗时**: 8小时 (1天)

**交付物**:
- Week 16完成总结
- Week 17任务计划文档
- 测试覆盖率报告

---

## 📋 Week 17 任务清单

### Phase 1: 测试覆盖率提升 (Days 1-2, 16h)

#### Task #1: 分析失败测试 (4h)
**状态**: ⏳ 待开始
**优先级**: P0

**任务**:
- [ ] 运行完整测试套件并收集失败信息
- [ ] 分类失败原因 (P0/P1/P2/P3)
- [ ] 识别批量修复模式
- [ ] 创建失败测试清单

**交付物**:
- `tests/FAILED-TESTS-ANALYSIS.md` (失败测试分析报告)
- 按优先级排序的修复清单

#### Task #2: 修复P0/P1测试失败 (8h)
**状态**: ⏳ 待开始
**优先级**: P0

**任务**:
- [ ] 修复所有P0级别测试失败
- [ ] 修复所有P1级别测试失败
- [ ] 验证修复后测试通过
- [ ] 更新测试用例文档

**预期修复类型**:
- 数据兼容性问题 (Legacy字段不匹配)
- 路由配置问题 (404错误)
- 权限检查问题 (访问拒绝)
- 时序问题 (Session/Cookie)

**交付物**:
- 修复后的测试文件
- 测试通过率提升到97%+

#### Task #3: 修复P2/P3测试失败 (4h)
**状态**: ⏳ 待开始
**优先级**: P1

**任务**:
- [ ] 修复批量P2级别失败 (边界条件)
- [ ] 修复批量P3级别失败 (次要问题)
- [ ] 记录延后修复的问题 (如果有)
- [ ] 生成测试覆盖率报告

**交付物**:
- 测试完成率达到98%+
- `tests/COVERAGE-REPORT.md` (覆盖率报告)

---

### Phase 2: Week 6 核心功能补全 (Days 3-4, 16h)

#### Task #4: PaymentController完整集成 (8h)
**状态**: ⏳ 待开始
**优先级**: P1

**当前状态**:
- ✅ PaymentService已实现
- ✅ 路由已配置
- ❌ 前端视图缺失
- ❌ Controller集成不完整

**任务**:
- [ ] 创建支付表单模板 (`templates/payment/pay.html.twig`)
- [ ] 实现支付页面视图 (积分确认 + 支付按钮)
- [ ] 集成CsrfTokenService
- [ ] 添加支付成功/失败提示
- [ ] 测试支付流程 (E2E)
- [ ] 添加支付历史记录显示

**前端页面对应**:
| Legacy模板 | Modern模板 | 状态 |
|-----------|-----------|------|
| `payment.htm` | `templates/payment/pay.html.twig` | ⏳ 待创建 |

**交付物**:
- PaymentController完整实现
- 支付表单模板
- 10+功能测试

#### Task #5: PollController前端集成 (4h)
**状态**: ⏳ 待开始
**优先级**: P1

**当前状态**:
- ✅ PollService已实现
- ✅ 投票数据模型完整
- ❌ 投票表单UI缺失

**任务**:
- [ ] 创建投票表单UI (`templates/post/poll_form.html.twig`)
- [ ] 实现投票选项动态添加/删除
- [ ] 集成到发帖表单 (单选/多选)
- [ ] 添加投票结果展示
- [ ] 测试投票流程

**前端页面对应**:
| Legacy模板 | Modern模板 | 状态 |
|-----------|-----------|------|
| `post_newthread.htm` (投票部分) | `templates/post/poll_form.html.twig` | ⏳ 待创建 |

**交付物**:
- 投票表单组件
- 投票结果展示组件
- 8+功能测试

#### Task #6: PostController优化 (4h)
**状态**: ⏳ 待开始
**优先级**: P1

**当前状态**:
- ✅ PostController已实现 (641行)
- ✅ 基本CRUD完整
- ⚠️ 缺少高级功能

**任务**:
- [ ] 添加草稿保存功能
- [ ] 添加自动保存功能
- [ ] 优化BBCode预览性能
- [ ] 添加附件上传进度显示
- [ ] 优化错误处理

**交付物**:
- PostController优化版本
- 草稿功能实现
- 6+功能测试

---

### Phase 3: Week 7 附件系统优化 (Days 5-6, 16h)

#### Task #7: 附件上传UI完整实现 (8h)
**状态**: ⏳ 待开始
**优先级**: P1

**当前状态**:
- ✅ 后端上传服务完整
- ✅ 5个API路由已配置
- ❌ 前端上传UI缺失

**任务**:
- [ ] 创建附件上传组件 (`templates/components/attachment_upload.html.twig`)
- [ ] 实现拖拽上传功能
- [ ] 实现批量上传
- [ ] 添加上传进度条
- [ ] 添加文件类型图标
- [ ] 添加缩略图预览
- [ ] 集成到发帖/回复表单

**功能特性**:
- 拖拽上传
- 批量选择文件
- 实时上传进度
- 缩略图预览
- 文件大小/格式验证
- 已上传文件管理 (删除/重新排序)

**交付物**:
- 附件上传组件
- 上传JavaScript模块
- 10+功能测试

#### Task #8: 附件下载/删除优化 (4h)
**状态**: ⏳ 待开始
**优先级**: P1

**任务**:
- [ ] 优化附件下载页面 (付费附件提示)
- [ ] 添加附件预览功能 (图片/PDF)
- [ ] 实现附件删除确认对话框
- [ ] 添加附件权限检查提示
- [ ] 优化HTTP Range支持

**交付物**:
- 附件预览组件
- 下载页面优化
- 6+功能测试

#### Task #9: 附件系统性能优化 (4h)
**状态**: ⏳ 待开始
**优先级**: P2

**任务**:
- [ ] 实现附件缩略图缓存
- [ ] 优化大文件上传 (分块上传)
- [ ] 添加CDN支持 (配置项)
- [ ] 优化附件存储路径
- [ ] 添加附件存储容量监控

**交付物**:
- 性能优化报告
- 缓存实现

---

### Phase 4: Week 8 高级主题功能 (Day 7, 8h)

#### Task #10: Reward Thread基础实现 (8h)
**状态**: ⏳ 待开始
**优先级**: P2

**当前状态**:
- ❌ RewardService未实现
- ❌ RewardController未创建
- ❌ 数据库表可能需要验证

**任务**:
- [ ] 验证Legacy悬赏主题表 (`cdb_reward`)
- [ ] 创建RewardService (悬赏创建/最佳答案/积分发放)
- [ ] 创建RewardController (悬赏表单/答案选择)
- [ ] 实现悬赏状态管理 (待解决/已解决)
- [ ] 添加悬赏UI组件

**功能特性**:
- 悬赏积分设置
- 最佳答案选择
- 积分自动发放
- 悬赏过期处理
- 退款机制 (无人回答)

**交付物**:
- RewardService
- RewardController
- 悬赏表单模板
- 10+功能测试

**注意**: 此任务可延后到Week 18，如果时间不够

---

## 📁 Week 17 交付文档

### 必须交付的文档 (5份)

1. **`WEEK17-COMPLETE.md`** (≥3,000字)
   - Week 17完整总结
   - 任务完成情况
   - 测试覆盖率提升详情
   - 功能补全清单

2. **`FAILED-TESTS-ANALYSIS.md`** (≥1,500字)
   - 失败测试分析报告
   - 修复方法总结
   - 批量修复模式

3. **`COVERAGE-REPORT.md`** (≥1,000字)
   - 测试覆盖率报告
   - 代码覆盖率分析
   - 未覆盖代码清单

4. **`WEEK17-FEATURES-COMPLETE.md`** (≥2,000字)
   - PaymentController完成报告
   - PollController集成报告
   - PostController优化总结
   - 附件系统UI实现报告

5. **`TASK-TRACKER.md`更新**
   - Week 17任务状态更新
   - 进度百分比更新
   - 下周任务规划

### 可选文档 (根据完成情况)

6. **`REWARD-THREAD-IMPLEMENTATION.md`** (≥1,500字)
   - 如果Task #10完成

7. **`PERFORMANCE-OPTIMIZATION.md`** (≥1,000字)
   - 如果Task #9完成

---

## 🎯 Week 17 成功标准

### 测试覆盖率目标
- [ ] 测试完成率 ≥ 98% (2584/2637)
- [ ] 无P0/P1级别测试失败
- [ ] 代码覆盖率 ≥ 90%

### 功能完整性目标
- [ ] PaymentController前端完整
- [ ] PollController前端集成
- [ ] PostController优化完成
- [ ] 附件上传UI完整

### 文档完整性目标
- [ ] 5份必须文档全部完成
- [ ] TASK-TRACKER.md更新
- [ ] PROGRESS-REPORT.md更新

### 生产就绪度目标
- [ ] 项目进度 ≥ 80% (从77%提升)
- [ ] P0 Critical Path = 100%
- [ ] P1 Core Features ≥ 60% (从53%提升)

---

## 📊 Week 17 进度跟踪

### Day 1: 测试分析 + P0修复
**目标**: 修复所有P0测试失败
**完成标准**: 测试完成率 ≥ 95%

### Day 2: P1/P2修复 + 覆盖率报告
**目标**: 达到98%测试完成率
**完成标准**: COVERAGE-REPORT.md生成

### Day 3: PaymentController集成
**目标**: 支付表单完整
**完成标准**: 支付流程E2E测试通过

### Day 4: PollController + PostController优化
**目标**: 投票UI完整 + PostController优化
**完成标准**: 8+测试通过

### Day 5: 附件上传UI实现
**目标**: 拖拽上传 + 进度显示
**完成标准**: 10+测试通过

### Day 6: 附件系统优化
**目标**: 下载/删除优化 + 性能优化
**完成标准**: 6+测试通过

### Day 7: Reward Thread + 文档
**目标**: 悬赏主题基础实现 + 所有文档
**完成标准**: 5份必须文档完成

---

## 🚨 风险管理

### 风险 1: 测试修复超出预期
**概率**: 中
**影响**: 高
**缓解措施**:
- 优先修复P0/P1，P2/P3可延后
- 如果无法达到98%，95%也可接受

### 风险 2: 附件UI实现复杂
**概率**: 中
**影响**: 中
**缓解措施**:
- 使用现成的JavaScript上传库
- 简化第一版功能 (基本上传即可)

### 风险 3: Reward Thread表结构问题
**概率**: 高
**影响**: 低
**缓解措施**:
- 优先验证表结构，如有问题立即延后
- 此任务可完全延后到Week 18

### 风险 4: 时间不够
**概率**: 中
**影响**: 中
**缓解措施**:
- 按优先级执行 (测试 > Payment > Poll > 附件 > Reward)
- Reward Thread可完全延后
- 附件性能优化可延后

---

## 📅 Week 17 时间线

```
Day 1 (测试分析+P0修复):    ████████████░░░░░░░░░░ 50%
Day 2 (P1/P2修复+覆盖率):    ██████████████░░░░░░░░ 60%
Day 3 (PaymentController):   █████████████████░░░░░ 70%
Day 4 (Poll+Post优化):       ███████████████████░░░ 80%
Day 5 (附件UI):              █████████████████████░ 90%
Day 6 (附件优化):            ██████████████████████ 95%
Day 7 (Reward+文档):         ███████████████████████ 100%
```

---

## 🎯 Week 17 后的状态预期

**项目进度**: 77% → 80% (+3%)
**P0 Critical Path**: 98% → 100% (+2%)
**P1 Core Features**: 53% → 60% (+7%)
**测试完成率**: 94% → 98% (+4%)
**生产就绪度**: 77% → 82% (+5%)

**可以上线**:
- ✅ 内部测试环境
- ✅ Beta测试环境
- ⚠️ 生产环境 (需要Week 18完善)

**Week 18预览**:
- AdminCP Phase 1 (基础框架)
- Reward Thread完整实现
- Activity Thread系统
- 性能测试执行

---

**文档创建**: 2026-02-21
**创建者**: Week 17 规划团队
**状态**: ⏳ 待用户审核
**版本**: 1.0
